#!/usr/bin/env bash
# -*- bash -*-

# Fail fast and fail hard.
set -eo pipefail

# for DEBUG; remove me.
# set -x

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
PYTHON_VERSION=${PYTHON_VERSION:-2.7}

source $BIN_DIR/utils

APYBIN=/opt/ActivePython-$PYTHON_VERSION/bin

puts-step "Using Python-$PYTHON_VERSION (ActivePython)"

export PATH=$APYBIN:$PATH
# Use /app-based for relocation during runtime.
export PYTHONUSERBASE=/app/app/.python
export PYTHONUNBUFFERED=True

cd $BUILD_DIR

if [[ -f requirements.pypm ]]; then
	puts-step "Installing requirements via PyPM"
	$APYBIN/pypm install -r requirements.pypm | indent
fi

if [[ -f requirements.txt ]]; then
	puts-step "Installing requirements via pip"
	$APYBIN/pip install --user --use-mirrors -r requirements.txt | cleanup_pip | indent
fi

puts-step "Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"$PYTHONUSERBASE/bin:$APYBIN:\$PATH\"; export PYTHONUSERBASE=$PYTHONUSERBASE; export PYTHONUNBUFFERED=True" > $BUILD_DIR/.profile.d/python.sh
