#!/usr/bin/env bash
# -*- bash -*-

# Fail fast and fail hard.
set -eo pipefail

# for DEBUG; remove me.
# set -x

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2

source $BIN_DIR/utils

# TODO: ActivePython isn't installed in our v2 VMs yet.
# http://bugs.activestate.com/show_bug.cgi?id=100291
# Workaround by installing Python here, until that bug is resolved.
if [ ! -e /opt/ActivePython-2.7 ]; then
    puts-step "Installing ActivePython 2.7.5.6"
    rm -rf $CACHE_DIR/x
    mkdir -p $CACHE_DIR/x
    cd $CACHE_DIR/x
    # XXX: not downloading tarball, but rsycing to dea_ng during dev
    tar zxf $ROOT_DIR/ActivePython*gz
    cd Acti*
    ./install.sh -I $BUILD_DIR/opt/ActivePython-2.7 | indent

    APYBIN=$BUILD_DIR/opt/ActivePython-2.7/bin
    # Now, the droplet will include the APy install.
else
    APYBIN=/opt/ActivePython-2.7/bin
fi

echo "ActivePython is at: $APYBIN"

VENV=$BUILD_DIR/venv

export PATH=$APYBIN:$PATH

puts-step "Creating virtualenv"
virtualenv -q --extra-search-dir=$ROOT_DIR/virtualenv_support $VENV | indent

if [ -f $BUILD_DIR/requirements.txt ]; then
    puts-step "Installing requirements via pip"
    $VENV/bin/pip install --use-mirrors -r $BUILD_DIR/requirements.txt | indent
fi

puts-step "Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
echo 'export PATH="$BUILD_DIR/venv/bin:$PATH"' > $BUILD_DIR/.profile.d/venv.sh
