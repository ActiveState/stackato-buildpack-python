#!/usr/bin/env bash
# -*- bash -*-

# Fail fast and fail hard.
set -eo pipefail

# for DEBUG; remove me.
# set -x

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
PYTHON_VERSION=${PYTHON_VERSION:-2.7}

source $BIN_DIR/utils

APYBIN=/opt/ActivePython-$PYTHON_VERSION/bin

echo "Using Python $PYTHON_VERSION" | indent

export PATH=$APYBIN:$PATH

# Use /app-based for relocation during runtime.
export PYTHONUSERBASE=/app/app/.python

puts-step "Installing requirements via pip"
$APYBIN/pip install --user --use-mirrors -r $BUILD_DIR/requirements.txt | indent

puts-step "Building runtime environment"
mkdir -p $BUILD_DIR/.profile.d
echo "export PATH=\"$PYTHONUSERBASE/bin:$APYBIN:\$PATH\"; export PYTHONUSERBASE=$PYTHONUSERBASE" > $BUILD_DIR/.profile.d/python.sh
